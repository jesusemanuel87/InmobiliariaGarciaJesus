# Sistema de Registro de Usuarios - InmobiliariaGarciaJesus

## üìã Descripci√≥n General

Sistema mejorado de registro de usuarios (Propietarios/Inquilinos) con validaci√≥n de administrador y reutilizaci√≥n inteligente de datos de personas.

## üéØ Objetivos

1. **Prevenir duplicaci√≥n de datos**: Reutilizar personas existentes sin usuario asociado
2. **Validaci√≥n administrativa**: Todos los registros requieren aprobaci√≥n de administrador
3. **Seguridad mejorada**: Estado inactivo por defecto hasta validaci√≥n
4. **UX clara**: Mensajes espec√≠ficos sobre el estado de validaci√≥n

---

## üîÑ Flujo de Registro

### **Usuario Nuevo se Registra**

```
1. Usuario completa formulario de registro
   ‚îú‚îÄ Tipo de Usuario (Propietario/Inquilino)
   ‚îú‚îÄ Datos de Usuario (Email, Usuario, Contrase√±a)
   ‚îî‚îÄ Datos Personales (Nombre, Apellido, DNI, Tel√©fono)

2. Sistema verifica DNI en base de datos
   ‚îÇ
   ‚îú‚îÄ DNI NO existe
   ‚îÇ  ‚îú‚îÄ Crear nueva persona (Estado = INACTIVO)
   ‚îÇ  ‚îî‚îÄ Crear nuevo usuario (Estado = INACTIVO)
   ‚îÇ
   ‚îî‚îÄ DNI existe
      ‚îú‚îÄ Tiene usuario asociado ‚Üí RECHAZAR registro
      ‚îÇ  ‚îî‚îÄ Mensaje: "Ya existe un usuario con este DNI. Use recuperaci√≥n de contrase√±a."
      ‚îÇ
      ‚îî‚îÄ NO tiene usuario ‚Üí REUTILIZAR persona
         ‚îî‚îÄ Crear usuario vinculado al ID existente (Estado = INACTIVO)

3. Redirecci√≥n a Login con mensaje:
   "Registro exitoso. Su cuenta ser√° activada por un administrador"
```

### **Usuario Intenta Iniciar Sesi√≥n**

```
1. Usuario ingresa credenciales

2. Sistema valida:
   ‚îú‚îÄ Email existe? NO ‚Üí "Credenciales inv√°lidas"
   ‚îú‚îÄ Contrase√±a correcta? NO ‚Üí "Credenciales inv√°lidas"
   ‚îú‚îÄ Usuario.Estado = INACTIVO? S√ç ‚Üí "Cuenta pendiente de validaci√≥n"
   ‚îú‚îÄ Persona.Estado = INACTIVO? S√ç ‚Üí "Credenciales inv√°lidas"
   ‚îî‚îÄ Todo OK ‚Üí Login exitoso
```

### **Administrador Valida Usuario**

```
1. Ver usuarios pendientes:
   - Consultar tabla Usuarios WHERE Estado = 0
   - Ver datos completos de la persona asociada

2. Verificar identidad:
   - Validar DNI y documentaci√≥n
   - Confirmar datos personales correctos
   - Verificar que no sea duplicado

3. Activar usuario:
   CALL sp_ActivarUsuario(usuario_id);
   
   Esto activa:
   - Usuario.Estado = 1 (Activo)
   - Persona.Estado = 1 (Activo)

4. Usuario puede iniciar sesi√≥n normalmente
```

---

## üõ†Ô∏è Implementaci√≥n T√©cnica

### **Backend - UsuarioService.cs**

#### **M√©todos Clave**

1. **`RegisterUsuarioAsync(RegisterViewModel model)`**
   - Valida email y username √∫nicos
   - Llama a `GetOrCreatePropietarioAsync()` o `GetOrCreateInquilinoAsync()`
   - Crea usuario con `Estado = false`
   - Retorna mensaje de validaci√≥n pendiente

2. **`GetOrCreatePropietarioAsync(RegisterViewModel model)`**
   ```csharp
   - Busca propietario por DNI usando PropietarioRepository.GetByDniAsync()
   - Si existe:
     - Verifica si tiene usuario con UsuarioRepository.GetUsuariosByPersonaAsync()
     - Con usuario ‚Üí Lanza excepci√≥n "DNI ya tiene usuario registrado"
     - Sin usuario ‚Üí Retorna ID existente (REUTILIZA)
   - Si NO existe:
     - Crea nuevo propietario con Estado = false
     - Retorna nuevo ID
   ```

3. **`GetOrCreateInquilinoAsync(RegisterViewModel model)`**
   - Misma l√≥gica que Propietarios

4. **`AuthenticateAsync(string email, string password)`**
   ```csharp
   - Valida email existe
   - Valida contrase√±a correcta
   - Valida Usuario.Estado = true (mensaje espec√≠fico si inactivo)
   - Valida Persona.Estado = true
   - Retorna usuario autenticado
   ```

### **Repositorios - Nuevos M√©todos**

#### **PropietarioRepository.cs**
```csharp
public async Task<Propietario?> GetByDniAsync(string dni)
```
- Busca propietario por DNI exacto
- Retorna `null` si no existe

#### **InquilinoRepository.cs**
```csharp
public async Task<Inquilino?> GetByDniAsync(string dni)
```
- Busca inquilino por DNI exacto
- Retorna `null` si no existe

#### **UsuarioRepository.cs**
```csharp
public async Task<List<Usuario>> GetUsuariosByPersonaAsync(int personaId, RolUsuario tipoPersona)
```
- Busca todos los usuarios vinculados a una persona espec√≠fica
- Filtra por tipo de rol (Propietario/Inquilino)
- Usado para detectar si persona ya tiene usuario

### **Frontend - Register.cshtml**

#### **Cambios Realizados**

1. **Alert Informativo**
   ```html
   <div class="alert alert-info">
     Su cuenta ser√° creada con estado Inactivo y deber√° ser validada 
     por un administrador antes de poder iniciar sesi√≥n.
   </div>
   ```

2. **Validaciones Simplificadas**
   - Mantiene validaci√≥n de Email/Username disponible
   - NO valida DNI (backend maneja l√≥gica compleja)
   - Mensajes de error claros del backend

### **Frontend - register.js**

#### **Validaciones**

1. **Email**: Verifica disponibilidad en tiempo real
2. **Username**: Verifica disponibilidad en tiempo real
3. **DNI**: NO se valida en frontend (l√≥gica compleja en backend)

---

## üìä Base de Datos

### **Tablas Afectadas**

#### **Usuarios**
```sql
Estado TINYINT(1) DEFAULT 0  -- 0 = Inactivo (pendiente), 1 = Activo
```

#### **Propietarios**
```sql
Estado TINYINT(1) DEFAULT 0  -- 0 = Inactivo, 1 = Activo
Dni VARCHAR(20) UNIQUE       -- √çndice para b√∫squeda r√°pida
```

#### **Inquilinos**
```sql
Estado TINYINT(1) DEFAULT 0  -- 0 = Inactivo, 1 = Activo
Dni VARCHAR(20) UNIQUE       -- √çndice para b√∫squeda r√°pida
```

### **Procedimiento Almacenado**

```sql
CALL sp_ActivarUsuario(usuario_id);
```

**Funcionalidad:**
- Activa `Usuarios.Estado = 1`
- Activa `Propietarios/Inquilinos.Estado = 1` seg√∫n corresponda
- Transacci√≥n at√≥mica (todo o nada)
- Manejo de errores robusto

### **Consultas √ötiles**

#### Ver usuarios pendientes
```sql
SELECT 
    u.Id, u.NombreUsuario, u.Email, u.Rol,
    CONCAT(p.Nombre, ' ', p.Apellido) AS NombreCompleto,
    p.Dni, u.FechaCreacion
FROM Usuarios u
LEFT JOIN Propietarios p ON u.PropietarioId = p.Id
LEFT JOIN Inquilinos i ON u.InquilinoId = i.Id
WHERE u.Estado = 0
ORDER BY u.FechaCreacion DESC;
```

#### Activar usuario manualmente (alternativa a SP)
```sql
UPDATE Usuarios SET Estado = 1 WHERE Id = {ID};
UPDATE Propietarios SET Estado = 1 WHERE Id = (SELECT PropietarioId FROM Usuarios WHERE Id = {ID});
```

---

## üîê Casos de Uso

### **Caso 1: Usuario Completamente Nuevo**

**Contexto:** Juan P√©rez nunca se registr√≥ en el sistema

```
1. Juan completa registro como Propietario
   DNI: 12345678
   Email: juan@example.com

2. Sistema verifica:
   ‚úì Email disponible
   ‚úì DNI no existe en Propietarios

3. Sistema crea:
   - Propietario (Id: 100, DNI: 12345678, Estado: 0)
   - Usuario (Id: 50, PropietarioId: 100, Estado: 0)

4. Resultado:
   ‚úÖ Registro exitoso
   ‚è≥ Pendiente de validaci√≥n
```

### **Caso 2: Persona Existe, Sin Usuario**

**Contexto:** Mar√≠a Garc√≠a fue registrada por un empleado pero nunca tuvo usuario

```
1. Base de datos actual:
   Propietarios: (Id: 200, DNI: 87654321, Estado: 1)
   Usuarios: Ninguno con PropietarioId = 200

2. Mar√≠a completa registro como Propietario
   DNI: 87654321
   Email: maria@example.com

3. Sistema verifica:
   ‚úì Email disponible
   ‚úì DNI existe en Propietarios (Id: 200)
   ‚úì Propietario NO tiene usuario asociado

4. Sistema crea:
   - Usuario (Id: 51, PropietarioId: 200, Estado: 0)
   - NO crea nuevo propietario (REUTILIZA Id: 200)

5. Resultado:
   ‚úÖ Registro exitoso
   ‚ôªÔ∏è Datos existentes reutilizados
   ‚è≥ Pendiente de validaci√≥n
```

### **Caso 3: DNI Ya Tiene Usuario**

**Contexto:** Carlos L√≥pez ya tiene usuario activo

```
1. Base de datos actual:
   Propietarios: (Id: 300, DNI: 11223344, Estado: 1)
   Usuarios: (Id: 60, PropietarioId: 300, Estado: 1)

2. Alguien intenta registrarse con DNI: 11223344

3. Sistema verifica:
   ‚úì DNI existe en Propietarios (Id: 300)
   ‚úó Propietario YA tiene usuario (Id: 60)

4. Resultado:
   ‚ùå Registro rechazado
   üí¨ Mensaje: "Ya existe un usuario registrado como Propietario con el DNI 11223344"
```

### **Caso 4: Persona Puede Tener M√∫ltiples Roles**

**Contexto:** Ana Mart√≠nez es Propietaria y tambi√©n quiere ser Inquilina

```
1. Base de datos actual:
   Propietarios: (Id: 400, DNI: 99887766, Estado: 1)
   Usuarios: (Id: 70, PropietarioId: 400, Rol: Propietario, Estado: 1)

2. Ana intenta registrarse como Inquilina con mismo DNI

3. Sistema verifica:
   ‚úì Email disponible (diferente al anterior)
   ‚úì DNI no existe en Inquilinos (diferente tabla)
   ‚úì DNI existe en Propietarios pero con rol diferente

4. Sistema crea:
   - Inquilino (Id: 500, DNI: 99887766, Estado: 0)
   - Usuario (Id: 71, InquilinoId: 500, Rol: Inquilino, Estado: 0)

5. Resultado:
   ‚úÖ Registro exitoso
   üë• Ana ahora tiene 2 usuarios con roles diferentes
   ‚è≥ Nuevo rol pendiente de validaci√≥n
```

---

## ‚úÖ Testing Manual

### **Test 1: Registro Nuevo Usuario**
1. Ir a `/Auth/Register`
2. Seleccionar tipo "Propietario"
3. Completar todos los campos con datos √∫nicos
4. Enviar formulario
5. **Esperado:** Redirect a `/Auth/Login` con mensaje "Registro exitoso. Su cuenta ser√° activada por un administrador"

### **Test 2: Intento de Login con Usuario Inactivo**
1. Registrar usuario (estado inactivo)
2. Ir a `/Auth/Login`
3. Ingresar credenciales correctas
4. **Esperado:** Error "Su cuenta est√° pendiente de validaci√≥n por un administrador"

### **Test 3: Activaci√≥n de Usuario**
1. Como administrador, ejecutar:
   ```sql
   CALL sp_ActivarUsuario(usuario_id);
   ```
2. Verificar en tabla Usuarios: `Estado = 1`
3. Verificar en tabla Propietarios/Inquilinos: `Estado = 1`
4. Intentar login nuevamente
5. **Esperado:** Login exitoso

### **Test 4: Reutilizaci√≥n de Persona**
1. Crear propietario manualmente en BD sin usuario
2. Registrarse con el mismo DNI
3. **Esperado:** No error de duplicaci√≥n, usa ID existente

### **Test 5: DNI Duplicado con Usuario**
1. Registrar usuario completo (con DNI X)
2. Intentar registrar otro usuario con mismo DNI
3. **Esperado:** Error "Ya existe un usuario registrado con el DNI X"

---

## üöÄ Deployment

### **Pasos de Migraci√≥n**

1. **Backup de Base de Datos**
   ```bash
   mysqldump -u root -p inmobiliaria > backup_before_migration.sql
   ```

2. **Ejecutar Migraci√≥n SQL**
   ```bash
   mysql -u root -p inmobiliaria < update_registro_usuarios_validacion.sql
   ```

3. **Verificar Procedimiento Almacenado**
   ```sql
   SHOW PROCEDURE STATUS WHERE Name = 'sp_ActivarUsuario';
   ```

4. **Compilar y Publicar Aplicaci√≥n**
   ```bash
   dotnet build --configuration Release
   dotnet publish --configuration Release
   ```

5. **Verificar Funcionalidad**
   - Crear usuario de prueba
   - Verificar estado inactivo
   - Activar con procedimiento
   - Verificar login exitoso

---

## üìù Notas para Administradores

### **Validaci√≥n de Usuarios Pendientes**

#### **Proceso Recomendado:**

1. **Consultar pendientes**
   ```sql
   SELECT * FROM vw_usuarios_pendientes;  -- Vista creada en migraci√≥n
   ```

2. **Verificar identidad**
   - Solicitar documentaci√≥n (DNI escaneado)
   - Verificar datos coinciden con registro
   - Confirmar legitimidad (llamada telef√≥nica, etc.)

3. **Activar usuario**
   ```sql
   CALL sp_ActivarUsuario(123);  -- Reemplazar 123 con ID real
   ```

4. **Notificar usuario** (opcional - futuro)
   - Email de bienvenida
   - Instrucciones de acceso
   - Link directo a login

### **Rechazar Registros Sospechosos**

Si detecta registro fraudulento:

```sql
-- NO activar usuario, simplemente eliminarlo (soft delete)
UPDATE Usuarios SET Estado = 0 WHERE Id = {ID};

-- Opcional: Agregar observaci√≥n
UPDATE Usuarios SET Observaciones = 'Registro rechazado: datos sospechosos' WHERE Id = {ID};
```

---

## üîß Troubleshooting

### **Error: "Ya existe un usuario con este email"**
**Causa:** Email ya registrado en tabla Usuarios  
**Soluci√≥n:** Usuario debe usar recuperaci√≥n de contrase√±a o registrarse con otro email

### **Error: "Ya existe un usuario registrado con el DNI X"**
**Causa:** Persona con ese DNI ya tiene usuario asociado  
**Soluci√≥n:** Usuario debe usar recuperaci√≥n de contrase√±a

### **Usuario no puede iniciar sesi√≥n despu√©s de activaci√≥n**
**Verificar:**
```sql
SELECT u.Estado AS UsuarioEstado, p.Estado AS PropietarioEstado
FROM Usuarios u
LEFT JOIN Propietarios p ON u.PropietarioId = p.Id
WHERE u.Email = 'email@example.com';
```
Ambos estados deben ser `1`

### **Procedimiento sp_ActivarUsuario no funciona**
**Verificar existencia:**
```sql
SHOW CREATE PROCEDURE sp_ActivarUsuario;
```
Si no existe, ejecutar nuevamente el script de migraci√≥n

---

## üìö Referencias

- **C√≥digo Backend:** `Services/UsuarioService.cs`
- **Repositorios:** `Repositories/PropietarioRepository.cs`, `InquilinoRepository.cs`, `UsuarioRepository.cs`
- **Vistas:** `Views/Auth/Register.cshtml`
- **JavaScript:** `wwwroot/js/Auth/register.js`
- **Migraci√≥n SQL:** `Database/Migrations/update_registro_usuarios_validacion.sql`
- **Controlador:** `Controllers/AuthController.cs`

---

## üìû Contacto y Soporte

Para dudas o problemas con el sistema de registro:
1. Revisar logs de aplicaci√≥n: `Logs/app-{date}.log`
2. Verificar estado de base de datos
3. Consultar esta documentaci√≥n
4. Contactar al equipo de desarrollo

---

**√öltima actualizaci√≥n:** 2025-01-18  
**Versi√≥n:** 1.0  
**Rama:** `feature/registro-usuarios-mejoras`
