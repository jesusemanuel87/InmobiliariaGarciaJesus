@model ConfiguracionAdminViewModel
@{
    ViewData["Title"] = "Panel de Administración";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cogs"></i> Panel de Administración</h2>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-list"></i> Ver Todas las Configuraciones
                </a>
            </div>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>
    </div>

    <!-- Meses Mínimos de Alquiler -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt"></i> Meses Mínimos de Alquiler</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure qué opciones de duración mínima estarán disponibles para los contratos.</p>
                    
                    <div class="row" id="mesesMinimosContainer">
                        @{
                            var mesesDisponibles = new[] { 6, 12, 18, 24, 30, 36 };
                            var mesesHabilitados = new Dictionary<int, bool>();
                            
                            if (Model.MesesMinimos != null)
                            {
                                foreach (var config in Model.MesesMinimos)
                                {
                                    if (!string.IsNullOrEmpty(config.Clave))
                                    {
                                        var parts = config.Clave.Split('_');
                                        if (parts.Length > 0)
                                        {
                                            var lastPart = parts.Last();
                                            if (int.TryParse(lastPart, out int mes) && bool.TryParse(config.Valor, out bool valor))
                                            {
                                                mesesHabilitados[mes] = valor;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        @foreach (var mes in mesesDisponibles)
                        {
                            var isEnabled = mesesHabilitados.ContainsKey(mes) ? mesesHabilitados[mes] : true;
                            <div class="col-md-2 col-sm-4 mb-3">
                                <button type="button" 
                                        class="btn btn-lg w-100 mes-toggle @(isEnabled ? "btn-success" : "btn-secondary")" 
                                        data-mes="@mes"
                                        data-enabled="@isEnabled.ToString().ToLower()">
                                    <i class="fas fa-calendar"></i><br>
                                    <strong>@mes meses</strong>
                                </button>
                            </div>
                        }
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="guardarMesesMinimos">
                            <i class="fas fa-save"></i> Guardar Configuración
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración de Multas -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Multa por Terminación Temprana</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Si se cumplió menos de la mitad del tiempo original</p>
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="multaTerminacionTemprana" 
                               value="@(Model.MultaTerminacionTemprana?.Valor ?? "2")" 
                               min="1" max="12">
                        <span class="input-group-text">meses</span>
                        <button class="btn btn-outline-primary" type="button" onclick="updateConfiguracion('MULTA_TERMINACION_TEMPRANA', 'multaTerminacionTemprana', 'Meses de multa por terminación temprana', @((int)TipoConfiguracion.MultaTerminacionTemprana))">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-clock"></i> Multa por Terminación Tardía</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Si se cumplió más de la mitad del tiempo original</p>
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="multaTerminacionTardia" 
                               value="@(Model.MultaTerminacionTardia?.Valor ?? "1")" 
                               min="1" max="12">
                        <span class="input-group-text">meses</span>
                        <button class="btn btn-outline-primary" type="button" onclick="updateConfiguracion('MULTA_TERMINACION_TARDIA', 'multaTerminacionTardia', 'Meses de multa por terminación tardía', @((int)TipoConfiguracion.MultaTerminacionTardia))">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuración de Intereses -->
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-percentage"></i> Interés 10-20 días</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="interesVencimiento" 
                               value="@(Model.InteresVencimiento?.Valor ?? "10")" 
                               min="0" max="100" step="0.1">
                        <span class="input-group-text">%</span>
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="updateConfiguracion('INTERES_VENCIMIENTO_10_20', 'interesVencimiento', 'Porcentaje de interés para vencimientos de 10-20 días', @((int)TipoConfiguracion.InteresVencimiento))">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-percentage"></i> Interés 20+ días</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="interesVencimientoExtendido" 
                               value="@(Model.InteresVencimientoExtendido?.Valor ?? "15")" 
                               min="0" max="100" step="0.1">
                        <span class="input-group-text">%</span>
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="updateConfiguracion('INTERES_VENCIMIENTO_20_PLUS', 'interesVencimientoExtendido', 'Porcentaje de interés para vencimientos de más de 20 días', @((int)TipoConfiguracion.InteresVencimientoExtendido))">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-percentage"></i> Interés Mensual</h6>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="interesVencimientoMensual" 
                               value="@(Model.InteresVencimientoMensual?.Valor ?? "20")" 
                               min="0" max="100" step="0.1">
                        <span class="input-group-text">%</span>
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="updateConfiguracion('INTERES_VENCIMIENTO_MENSUAL', 'interesVencimientoMensual', 'Porcentaje de interés mensual', @((int)TipoConfiguracion.InteresVencimientoMensual))">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toggle de meses mínimos
            $('.mes-toggle').click(function() {
                var $btn = $(this);
                var isEnabled = $btn.data('enabled');
                
                if (isEnabled) {
                    $btn.removeClass('btn-success').addClass('btn-secondary');
                    $btn.data('enabled', false);
                } else {
                    $btn.removeClass('btn-secondary').addClass('btn-success');
                    $btn.data('enabled', true);
                }
            });

            // Guardar configuración de meses mínimos
            $('#guardarMesesMinimos').click(function() {
                var mesesHabilitados = [];
                $('.mes-toggle').each(function() {
                    if ($(this).data('enabled')) {
                        mesesHabilitados.push(parseInt($(this).data('mes')));
                    }
                });

                $.ajax({
                    url: '@Url.Action("UpdateMesesMinimos")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(mesesHabilitados),
                    success: function(response) {
                        if (response.success) {
                            showAlert('success', response.message);
                        } else {
                            showAlert('danger', response.message);
                        }
                    },
                    error: function() {
                        showAlert('danger', 'Error al guardar la configuración');
                    }
                });
            });
        });

        function updateConfiguracion(clave, inputId, descripcion, tipo) {
            var valor = $('#' + inputId).val();
            
            $.ajax({
                url: '@Url.Action("UpdateConfiguracion")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Clave: clave,
                    Valor: valor,
                    Descripcion: descripcion,
                    Tipo: tipo
                }),
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function() {
                    showAlert('danger', 'Error al actualizar la configuración');
                }
            });
        }

        function showAlert(type, message) {
            var alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('.container-fluid .row:first .col-12').after(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}
