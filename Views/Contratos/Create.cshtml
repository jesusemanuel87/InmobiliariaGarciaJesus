@model InmobiliariaGarciaJesus.Models.Contrato

@{
    ViewData["Title"] = "Crear Contrato";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus"></i> Crear Contrato</h2>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form asp-action="Create">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="InquilinoId" class="form-label"></label>
                                    <select asp-for="InquilinoId" class="form-select">
                                        <option value="">Seleccionar inquilino...</option>
                                        @foreach (var inquilino in ViewBag.Inquilinos as IEnumerable<InmobiliariaGarciaJesus.Models.Inquilino>)
                                        {
                                            <option value="@inquilino.Id">@inquilino.Nombre @inquilino.Apellido - DNI: @inquilino.Dni</option>
                                        }
                                    </select>
                                    <span asp-validation-for="InquilinoId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="InmuebleId" class="form-label"></label>
                                    <select asp-for="InmuebleId" class="form-select">
                                        <option value="">Seleccionar inmueble...</option>
                                        @foreach (var inmueble in ViewBag.Inmuebles as IEnumerable<InmobiliariaGarciaJesus.Models.Inmueble>)
                                        {
                                            <option value="@inmueble.Id">@inmueble.Direccion - @inmueble.Tipo</option>
                                        }
                                    </select>
                                    <span asp-validation-for="InmuebleId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Date suggestion and validation messages -->
                        <div id="fecha-suggestion" class="mb-2"></div>
                        <div id="date-validation-message" class="mb-3"></div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="FechaInicio" class="form-label"></label>
                                    <input asp-for="FechaInicio" class="form-control" type="date" id="fechaInicio" />
                                    <span asp-validation-for="FechaInicio" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="FechaFin" class="form-label"></label>
                                    <input asp-for="FechaFin" class="form-control" type="date" id="fechaFin" />
                                    <span asp-validation-for="FechaFin" class="text-danger"></span>
                                    <small class="form-text text-muted">Se calcula automáticamente según la fecha de inicio</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Precio" class="form-label"></label>
                                    <input asp-for="Precio" class="form-control" type="number" step="0.01" min="0.01" />
                                    <span asp-validation-for="Precio" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de duración rápida -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt me-2"></i>Duración del Contrato
                                </label>
                                
                                @{
                                    var mesesConfig = ViewBag.MesesMinimos as IEnumerable<InmobiliariaGarciaJesus.Models.Configuracion>;
                                }
                                
                                                            
                                <div class="d-flex flex-wrap gap-2">
                                    @{
                                        if (mesesConfig != null && mesesConfig.Any())
                                        {
                                            var mesesDisponibles = new List<int>();
                                            foreach (var config in mesesConfig)
                                            {
                                                if (!string.IsNullOrEmpty(config.Clave) && config.Valor.ToLower() == "true")
                                                {
                                                    var match = System.Text.RegularExpressions.Regex.Match(config.Clave, @"MESES_MINIMOS_(\d+)");
                                                    if (match.Success)
                                                    {
                                                        mesesDisponibles.Add(int.Parse(match.Groups[1].Value));
                                                    }
                                                }
                                            }
                                            
                                            mesesDisponibles.Sort();
                                            var isFirst = true;
                                            foreach (var meses in mesesDisponibles)
                                            {
                                                var btnClass = isFirst ? "btn btn-primary duration-btn" : "btn btn-outline-primary duration-btn";
                                                <button type="button" class="@btnClass" 
                                                        data-months="@meses" 
                                                        title="Establecer duración de @meses meses">
                                                    <i class="fas fa-calendar me-1"></i>@meses meses
                                                </button>
                                                isFirst = false;
                                            }
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning mb-2">
                                                <small>No se encontraron configuraciones válidas. Usando botones por defecto.</small>
                                            </div>
                                            <button type="button" class="btn btn-primary duration-btn" data-months="6" title="Establecer duración de 6 meses">
                                                <i class="fas fa-calendar me-1"></i>6 meses
                                            </button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-months="12" title="Establecer duración de 12 meses">
                                                <i class="fas fa-calendar me-1"></i>12 meses
                                            </button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-months="18" title="Establecer duración de 18 meses">
                                                <i class="fas fa-calendar me-1"></i>18 meses
                                            </button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-months="24" title="Establecer duración de 24 meses">
                                                <i class="fas fa-calendar me-1"></i>24 meses
                                            </button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-months="30" title="Establecer duración de 30 meses">
                                                <i class="fas fa-calendar me-1"></i>30 meses
                                            </button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-months="36" title="Establecer duración de 36 meses">
                                                <i class="fas fa-calendar me-1"></i>36 meses
                                            </button>
                                        }
                                    }
                                </div>
                                <small class="form-text text-muted">
                                    Haga clic en un botón para establecer automáticamente la fecha de fin al último día del mes correspondiente
                                </small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Crear Contrato
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/Contrato/contrato-validation.js"></script>
    <script src="~/js/Contrato/create-contrato.js"></script>
    <script>
        // Transfer ViewBag data to JavaScript
        window.contratoCreateData = {
            configuraciones: @Html.Raw(Json.Serialize(ViewBag.MesesMinimos ?? new List<object>())),
            inmuebles: @Html.Raw(Json.Serialize(ViewBag.Inmuebles ?? new List<object>()))
        };
    </script>
}
