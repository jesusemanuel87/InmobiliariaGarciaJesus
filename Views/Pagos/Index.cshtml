@{
    ViewData["Title"] = "Pagos";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-money-bill-wave"></i> Pagos</h2>
            </div>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Filtros -->
            <div class="card shadow mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label for="filtroEstado" class="form-label">
                                <i class="fas fa-filter me-1"></i>Estado Pago
                            </label>
                            <select id="filtroEstado" class="form-select">
                                <option value="">Todos los estados</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Vencido">Vencido</option>
                                <option value="Pagado">Pagado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtroEstadoContrato" class="form-label">
                                <i class="fas fa-file-contract me-1"></i>Estado Contrato
                            </label>
                            <select id="filtroEstadoContrato" class="form-select">
                                <option value="">Todos los estados</option>
                                <option value="Reservado">Reservado</option>
                                <option value="Activo">Activo</option>
                                <option value="Finalizado">Finalizado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtroNumeroContrato" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>N° Contrato
                            </label>
                            <input type="number" id="filtroNumeroContrato" class="form-control" placeholder="Número">
                        </div>
                        <div class="col-md-2">
                            <label for="filtroMes" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Mes Vencimiento
                            </label>
                            <select id="filtroMes" class="form-select">
                                <option value="">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtroAnio" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>Año
                            </label>
                            <select id="filtroAnio" class="form-select">
                                <option value="">Todos los años</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filtroMonto" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>Rango Monto
                            </label>
                            <select id="filtroMonto" class="form-select">
                                <option value="">Todos los montos</option>
                                <option value="0-50000">$0 - $50K</option>
                                <option value="50000-100000">$50K - $100K</option>
                                <option value="100000-200000">$100K - $200K</option>
                                <option value="200000-999999999">Más de $200K</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" id="limpiarFiltros" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                            </button>
                            <button type="button" id="resetearFiltros" class="btn btn-outline-primary">
                                <i class="fas fa-undo me-1"></i>Valores por Defecto
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="pagosTable" class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-end" style="width: 80px;">Contrato</th>
                                    <th>Inquilino</th>
                                    <th>Inmueble</th>
                                    <th>Vencimiento</th>
                                    <th class="text-end">Monto</th>
                                    <th class="text-end">Multas</th>
                                    <th class="text-end">Intereses</th>
                                    <th class="text-end">Total a Pagar</th>
                                    <th>Estado</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- DataTables will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div id="modalContainer"></div>

<!-- Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Éxito</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <span id="toastMessage"></span>
        </div>
    </div>
</div>

<!-- Contenedor para el modal de auditoría -->
<div id="auditoriaModalContainer"></div>

@section Scripts {
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="~/js/shared/datatables-config.js"></script>
    
    <!-- Pagos Modular Scripts -->
    <script src="~/js/Pagos/pagos-utilities.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/Pagos/pagos-datatables.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/Pagos/pagos-modals.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/Pagos/pagos-filters.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/Pagos/pagos-manager.js?v=@DateTime.Now.Ticks"></script>
    <script src="~/js/Pagos/index.js?v=@DateTime.Now.Ticks"></script>
    
    <script>
        // Variable global para el rol del usuario
        window.userRole = '@(User.IsInRole("Administrador") ? "Administrador" : User.IsInRole("Empleado") ? "Empleado" : "Usuario")';
        
        // Función para cargar el modal de auditoría de pagos
        function loadPagoAuditoriaModal(pagoId) {
            fetch(`/Pagos/AuditoriaModal/${pagoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar información de auditoría');
                    }
                    return response.text();
                })
                .then(html => {
                    document.getElementById('auditoriaModalContainer').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('pagoAuditoriaModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar información de auditoría');
                });
        }
    </script>
    
}
